<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AEP Batch Ingestion Calculator</title>
    <style>
        :root {
            --primary-color: #0066cc;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --border-color: #dee2e6;
            --bg-light: #f8f9fa;
            --bg-growth: #e7f3ff;
            --text-muted: #6c757d;
            --card-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
        }

        header h1 {
            font-size: 1.8rem;
            color: #333;
            margin-bottom: 5px;
        }

        header p {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        .reset-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .reset-btn:hover {
            background: #c82333;
        }

        .save-indicator {
            font-size: 0.8rem;
            color: var(--success-color);
            opacity: 0;
            transition: opacity 0.3s;
            margin-top: 5px;
        }

        .save-indicator.visible {
            opacity: 1;
        }

        /* Sections */
        section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
        }

        section h2 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }

        /* Schema Section */
        .schema-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .schema-container {
                grid-template-columns: 1fr;
            }
        }

        .schema-panel {
            border: 1px solid var(--border-color);
            border-radius: 5px;
            overflow: hidden;
        }

        .schema-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: var(--bg-light);
            cursor: pointer;
            user-select: none;
        }

        .schema-header:hover {
            background: #e9ecef;
        }

        .schema-header h3 {
            font-size: 1rem;
            font-weight: 600;
        }

        .schema-toggle {
            font-size: 1.2rem;
            transition: transform 0.3s;
        }

        .schema-panel.expanded .schema-toggle {
            transform: rotate(180deg);
        }

        .schema-preview {
            padding: 10px 15px;
            background: #f1f3f5;
            font-family: monospace;
            font-size: 0.8rem;
            color: var(--text-muted);
            white-space: pre;
            overflow: hidden;
            max-height: 60px;
            border-top: 1px solid var(--border-color);
        }

        .schema-panel.expanded .schema-preview {
            display: none;
        }

        .schema-content {
            display: none;
            padding: 15px;
            border-top: 1px solid var(--border-color);
        }

        .schema-panel.expanded .schema-content {
            display: block;
        }

        .schema-textarea {
            width: 100%;
            height: 400px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.85rem;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            resize: vertical;
            line-height: 1.4;
        }

        .schema-textarea.invalid {
            border-color: var(--danger-color);
            background-color: #fff5f5;
        }

        .schema-info {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.85rem;
        }

        .byte-count {
            color: var(--text-muted);
        }

        .error-message {
            color: var(--danger-color);
            font-weight: 500;
        }

        /* Configuration Inputs */
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .config-group {
            padding: 15px;
            background: var(--bg-light);
            border-radius: 5px;
        }

        .config-group h3 {
            font-size: 0.95rem;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .input-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .input-row:last-child {
            margin-bottom: 0;
        }

        .input-row label {
            flex: 0 0 180px;
            font-size: 0.9rem;
        }

        .input-row input[type="number"],
        .input-row select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .input-row input[type="number"]:focus,
        .input-row select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .input-suffix {
            margin-left: 8px;
            color: var(--text-muted);
            font-size: 0.85rem;
            flex: 0 0 60px;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .slider-container input[type="range"] {
            flex: 1;
        }

        .slider-container input[type="number"] {
            width: 70px;
            flex: 0 0 70px;
        }

        /* Growth Projection Section */
        .growth-section {
            background: var(--bg-growth);
        }

        .growth-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .growth-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .growth-input-group label {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .growth-input-group input {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .growth-comparison {
            background: white;
            border-radius: 5px;
            padding: 20px;
            font-family: monospace;
            font-size: 0.9rem;
            white-space: pre-line;
            overflow-x: auto;
        }

        .growth-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .growth-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .growth-table th,
        .growth-table td {
            text-align: left;
            padding: 8px 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .growth-table th {
            font-weight: 600;
            background: var(--bg-light);
        }

        .growth-impact {
            background: var(--bg-light);
            padding: 15px;
            border-radius: 5px;
        }

        .growth-impact-title {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .growth-impact-item {
            margin-left: 20px;
            padding: 3px 0;
        }

        /* Results Dashboard */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .result-card {
            background: var(--bg-light);
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid var(--primary-color);
        }

        .result-card.primary {
            background: linear-gradient(135deg, #e7f3ff 0%, #f0f7ff 100%);
            border-left-color: var(--primary-color);
        }

        .result-card.success {
            border-left-color: var(--success-color);
        }

        .result-card.warning {
            border-left-color: var(--warning-color);
        }

        .result-card.danger {
            border-left-color: var(--danger-color);
        }

        .result-card h3 {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 15px;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            color: #555;
            font-size: 0.9rem;
        }

        .result-value {
            font-weight: 600;
            font-family: monospace;
            font-size: 0.95rem;
        }

        .result-card.primary .result-value {
            color: var(--primary-color);
        }

        .status-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-badge.success {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.danger {
            background: #f8d7da;
            color: #721c24;
        }

        /* Warning Banner */
        .warning-banner {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .warning-banner.visible {
            display: block;
        }

        /* Info Message */
        .info-message {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            color: #004085;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-top: 5px;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 15px;
            }

            .input-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .input-row label {
                flex: none;
            }

            .input-row input,
            .input-row select,
            .slider-container {
                width: 100%;
            }

            .input-suffix {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>AEP Batch Ingestion Calculator</h1>
                <p>Model your data transfer capacity against annual bandwidth limits</p>
                <div id="saveIndicator" class="save-indicator">Saved</div>
            </div>
            <button class="reset-btn" onclick="resetToDefaults()">Reset to Defaults</button>
        </header>

        <div id="warningBanner" class="warning-banner">
            localStorage is not available. Your settings will not be persisted.
        </div>

        <!-- Section 1: Schema Configuration -->
        <section>
            <h2>Schema Configuration</h2>
            <div class="schema-container">
                <div class="schema-panel" id="profilePanel">
                    <div class="schema-header" onclick="toggleSchema('profile')">
                        <h3>Profile Schema (JSON)</h3>
                        <span class="schema-toggle">▼</span>
                    </div>
                    <div class="schema-preview" id="profilePreview"></div>
                    <div class="schema-content">
                        <textarea class="schema-textarea" id="profileSchema" spellcheck="false"></textarea>
                        <div class="schema-info">
                            <span class="byte-count" id="profileByteCount">0 bytes</span>
                            <span class="error-message" id="profileError"></span>
                        </div>
                    </div>
                </div>

                <div class="schema-panel" id="consentPanel">
                    <div class="schema-header" onclick="toggleSchema('consent')">
                        <h3>Consent Schema (JSON)</h3>
                        <span class="schema-toggle">▼</span>
                    </div>
                    <div class="schema-preview" id="consentPreview"></div>
                    <div class="schema-content">
                        <textarea class="schema-textarea" id="consentSchema" spellcheck="false"></textarea>
                        <div class="schema-info">
                            <span class="byte-count" id="consentByteCount">0 bytes</span>
                            <span class="error-message" id="consentError"></span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 2: Configuration Inputs -->
        <section>
            <h2>Configuration</h2>
            <div class="config-grid">
                <div class="config-group">
                    <h3>Compression Settings</h3>
                    <div class="input-row">
                        <label for="compressionType">Compression Type</label>
                        <select id="compressionType">
                            <option value="bzip2">BZIP2 (17.5x ratio)</option>
                            <option value="gzip">GZIP (10x ratio)</option>
                        </select>
                    </div>
                </div>

                <div class="config-group">
                    <h3>Volume Settings</h3>
                    <div class="input-row">
                        <label for="recordsToHydrate">Records to Hydrate</label>
                        <input type="number" id="recordsToHydrate" value="150" min="1" max="10000">
                        <span class="input-suffix">million</span>
                    </div>
                    <div class="input-row">
                        <label for="bandwidthLimit">Annual Bandwidth Limit</label>
                        <input type="number" id="bandwidthLimit" value="2" min="0.1" max="100" step="0.1">
                        <span class="input-suffix">TB</span>
                    </div>
                </div>

                <div class="config-group">
                    <h3>Daily Change Rates</h3>
                    <div class="input-row">
                        <label for="profileChangeRate">Profile Change Rate</label>
                        <div class="slider-container">
                            <input type="range" id="profileChangeSlider" min="0" max="100" value="10">
                            <input type="number" id="profileChangeRate" value="10" min="0" max="100">
                            <span class="input-suffix">%</span>
                        </div>
                    </div>
                    <div class="input-row">
                        <label for="consentChangeRate">Consent Change Rate</label>
                        <div class="slider-container">
                            <input type="range" id="consentChangeSlider" min="0" max="100" value="5">
                            <input type="number" id="consentChangeRate" value="5" min="0" max="100">
                            <span class="input-suffix">%</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 3: Growth Projection -->
        <section class="growth-section">
            <h2>Growth Projection</h2>
            <div class="growth-inputs">
                <div class="growth-input-group">
                    <label for="growthDate">Growth Date</label>
                    <input type="date" id="growthDate">
                    <div id="growthDateWarning" class="info-message" style="display:none;">Growth date is in the past. Using today's date.</div>
                </div>
                <div class="growth-input-group">
                    <label for="growthMultiplier">Growth Multiplier</label>
                    <input type="number" id="growthMultiplier" value="1.5" min="0.1" max="10" step="0.1">
                    <div id="growthMultiplierInfo" class="info-message" style="display:none;">Multiplier &lt; 1 indicates schema shrinkage.</div>
                </div>
            </div>

            <div class="growth-comparison" id="growthComparison">
                <!-- Populated by JavaScript -->
            </div>
        </section>

        <!-- Section 4: Results Dashboard -->
        <section>
            <h2>Results Dashboard</h2>
            <div class="results-grid">
                <div class="result-card" id="profileMetrics">
                    <h3>Profile Size</h3>
                    <div class="result-item">
                        <span class="result-label">Uncompressed</span>
                        <span class="result-value" id="profileUncompressed">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Compressed</span>
                        <span class="result-value" id="profileCompressed">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Compression Ratio</span>
                        <span class="result-value" id="profileRatio">-</span>
                    </div>
                </div>

                <div class="result-card" id="consentMetrics">
                    <h3>Consent Size</h3>
                    <div class="result-item">
                        <span class="result-label">Uncompressed</span>
                        <span class="result-value" id="consentUncompressed">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Compressed</span>
                        <span class="result-value" id="consentCompressed">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Compression Ratio</span>
                        <span class="result-value" id="consentRatio">-</span>
                    </div>
                </div>

                <div class="result-card" id="combinedMetrics">
                    <h3>Combined (Per Record)</h3>
                    <div class="result-item">
                        <span class="result-label">Uncompressed</span>
                        <span class="result-value" id="combinedUncompressed">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Compressed</span>
                        <span class="result-value" id="combinedCompressed">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Total for All Records</span>
                        <span class="result-value" id="combinedTotal">-</span>
                    </div>
                </div>

                <div class="result-card" id="hydrationSummary">
                    <h3>Initial Hydration</h3>
                    <div class="result-item">
                        <span class="result-label">Total Records</span>
                        <span class="result-value" id="hydrationRecords">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Data Size</span>
                        <span class="result-value" id="hydrationSize">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">% of Annual Limit</span>
                        <span class="result-value" id="hydrationPercent">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Remaining Budget</span>
                        <span class="result-value" id="hydrationRemaining">-</span>
                    </div>
                </div>

                <div class="result-card" id="dailySyncSummary">
                    <h3>Daily Sync Requirement</h3>
                    <div class="result-item">
                        <span class="result-label">Profile Records</span>
                        <span class="result-value" id="dailyProfileRecords">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Consent Records</span>
                        <span class="result-value" id="dailyConsentRecords">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Total Records</span>
                        <span class="result-value" id="dailyTotalRecords">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Data Size</span>
                        <span class="result-value" id="dailySize">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Monthly Estimate</span>
                        <span class="result-value" id="monthlySize">-</span>
                    </div>
                </div>

                <div class="result-card primary" id="budgetForecast">
                    <h3>Budget Forecast (Current Schema Size)</h3>
                    <div class="result-item">
                        <span class="result-label">Days Until Limit</span>
                        <span class="result-value" id="forecastDays">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Months</span>
                        <span class="result-value" id="forecastMonths">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Sustainable</span>
                        <span class="result-value" id="forecastSustainable">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Annual Usage</span>
                        <span class="result-value" id="forecastUsage">-</span>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        // Default schemas
        const DEFAULT_PROFILE_SCHEMA = {
            "neustarOffline": "NOFF1234567890ABCDEF",
            "neustarOnline": "NON1234567890ABCDEF",
            "knownUUID": "550e8400-e29b-41d4-a716-446655440000",
            "wireless": [
                {
                    "ctn": "5551234567",
                    "activationDate": "2023-01-15",
                    "subscriberStatus": "Active",
                    "device": { "make": "Apple", "model": "iPhone 15 Pro", "itemId": "ITM12345678" },
                    "soc": { "planSoc": "UNLPREM5G", "insuranceSoc": "PRTPREM", "planSocEffectiveDate": "2023-01-15" },
                    "contract": { "startDate": "2023-01-15", "endDate": "2025-01-15", "status": "Active", "reasonCode": "NEW" },
                    "contactDetails": {
                        "mktPhoneNumber": "5559876543",
                        "mktEmail": "john.doe@email.com",
                        "mktPostalAddress": {
                            "addressLine1": "123 Main St",
                            "addressLine2": "Apt 4B",
                            "addressLine3": "",
                            "city": "New York",
                            "state": "NY",
                            "country": "US",
                            "zipcode": "10001",
                            "zipcode4": "1234"
                        }
                    },
                    "banDetails": {
                        "ban": "123456789",
                        "accountStatus": "Active",
                        "accountType": "Individual",
                        "wirelessAccountType": "Postpaid",
                        "wirelessAccountSubType": "Premium",
                        "liabilityType": "Individual",
                        "autoPay": true,
                        "firstName": "John",
                        "lastName": "Doe",
                        "billingLanguage": "EN"
                    }
                }
            ],
            "wireline": [
                {
                    "ban": "987654321",
                    "accountType": "Individual",
                    "accountStatus": "Active",
                    "givenName": "John",
                    "familyName": "Doe",
                    "productTypes": "Internet",
                    "maxUploadSpeed": "1Gbps",
                    "emailAddress": "john.doe@email.com",
                    "phoneNumber": "5551234567",
                    "billingZip": "10001",
                    "billingState": "NY",
                    "autoPay": "Y",
                    "contract": { "startDate": "2023-06-01", "endDate": "2025-06-01", "status": "Active" },
                    "device": { "make": "Arris", "model": "BGW320", "itemId": "ITM87654321" },
                    "soc": { "planSoc": "FIBER1000", "insuranceSoc": "NONE" }
                }
            ]
        };

        const DEFAULT_CONSENT_SCHEMA = {
            "knownUUID": "550e8400-e29b-41d4-a716-446655440000",
            "consentTimestamp": "2024-01-15T10:30:00Z",
            "consentVersion": "2.1",
            "consentSource": "Web Portal",
            "channels": {
                "email": { "opted": true, "timestamp": "2024-01-15T10:30:00Z", "source": "Web" },
                "sms": { "opted": false, "timestamp": "2024-01-10T08:00:00Z", "source": "IVR" },
                "push": { "opted": true, "timestamp": "2024-01-15T10:30:00Z", "source": "App" },
                "directMail": { "opted": true, "timestamp": "2023-06-01T00:00:00Z", "source": "Store" }
            },
            "purposes": {
                "marketing": { "opted": true, "timestamp": "2024-01-15T10:30:00Z" },
                "analytics": { "opted": true, "timestamp": "2024-01-15T10:30:00Z" },
                "thirdPartySharing": { "opted": false, "timestamp": "2024-01-15T10:30:00Z" },
                "personalization": { "opted": true, "timestamp": "2024-01-15T10:30:00Z" }
            },
            "doNotSell": false,
            "doNotShare": false,
            "privacyPolicyVersion": "3.2",
            "privacyPolicyAcceptedAt": "2024-01-15T10:30:00Z"
        };

        // Compression ratios
        const COMPRESSION_RATIOS = {
            bzip2: 17.5,
            gzip: 10.0
        };

        // localStorage keys
        const STORAGE_KEYS = {
            profileJson: 'aep_calc_profile_json',
            consentJson: 'aep_calc_consent_json',
            compressionType: 'aep_calc_compression_type',
            recordsMillions: 'aep_calc_records_millions',
            bandwidthLimitTb: 'aep_calc_bandwidth_limit_tb',
            profileChangeRate: 'aep_calc_profile_change_rate',
            consentChangeRate: 'aep_calc_consent_change_rate',
            growthDate: 'aep_calc_growth_date',
            growthMultiplier: 'aep_calc_growth_multiplier',
            uiState: 'aep_calc_ui_state'
        };

        // State
        let state = {
            profileValid: true,
            consentValid: true,
            saveTimeout: null,
            localStorageAvailable: true
        };

        // Check localStorage availability
        function checkLocalStorage() {
            try {
                const test = '__storage_test__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
            } catch (e) {
                return false;
            }
        }

        // Format numbers
        function formatNumber(num) {
            return num.toLocaleString('en-US');
        }

        function formatBytes(bytes) {
            if (bytes < 1024) return formatNumber(Math.round(bytes)) + ' bytes';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
            if (bytes < 1024 * 1024 * 1024 * 1024) return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
            return (bytes / (1024 * 1024 * 1024 * 1024)).toFixed(3) + ' TB';
        }

        function formatPercent(value) {
            return value.toFixed(1) + '%';
        }

        function formatDate(date) {
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Get byte length of string
        function getByteLength(str) {
            return new TextEncoder().encode(str).length;
        }

        // Validate JSON
        function validateJson(str) {
            try {
                JSON.parse(str);
                return { valid: true, error: null };
            } catch (e) {
                return { valid: false, error: e.message };
            }
        }

        // Toggle schema panel
        function toggleSchema(type) {
            const panel = document.getElementById(type + 'Panel');
            panel.classList.toggle('expanded');
            saveUiState();
        }

        // Update schema preview
        function updatePreview(type) {
            const textarea = document.getElementById(type + 'Schema');
            const preview = document.getElementById(type + 'Preview');
            const lines = textarea.value.split('\n').slice(0, 3);
            preview.textContent = lines.join('\n') + (textarea.value.split('\n').length > 3 ? '\n...' : '');
        }

        // Save to localStorage
        function saveToStorage(key, value) {
            if (!state.localStorageAvailable) return;
            try {
                localStorage.setItem(key, JSON.stringify(value));
                showSaveIndicator();
            } catch (e) {
                console.error('Failed to save to localStorage:', e);
            }
        }

        // Load from localStorage
        function loadFromStorage(key, defaultValue) {
            if (!state.localStorageAvailable) return defaultValue;
            try {
                const stored = localStorage.getItem(key);
                return stored ? JSON.parse(stored) : defaultValue;
            } catch (e) {
                console.error('Failed to load from localStorage:', e);
                return defaultValue;
            }
        }

        // Show save indicator
        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.add('visible');
            setTimeout(() => indicator.classList.remove('visible'), 1500);
        }

        // Save UI state
        function saveUiState() {
            const uiState = {
                profileExpanded: document.getElementById('profilePanel').classList.contains('expanded'),
                consentExpanded: document.getElementById('consentPanel').classList.contains('expanded')
            };
            saveToStorage(STORAGE_KEYS.uiState, uiState);
        }

        // Debounced save for textareas
        function debouncedSave(key, value) {
            if (state.saveTimeout) clearTimeout(state.saveTimeout);
            state.saveTimeout = setTimeout(() => {
                saveToStorage(key, value);
            }, 500);
        }

        // Get default growth date (6 months from today)
        function getDefaultGrowthDate() {
            const date = new Date();
            date.setMonth(date.getMonth() + 6);
            return date.toISOString().split('T')[0];
        }

        // Initialize
        function init() {
            state.localStorageAvailable = checkLocalStorage();

            if (!state.localStorageAvailable) {
                document.getElementById('warningBanner').classList.add('visible');
            }

            // Load saved values or defaults
            document.getElementById('profileSchema').value = loadFromStorage(
                STORAGE_KEYS.profileJson,
                JSON.stringify(DEFAULT_PROFILE_SCHEMA, null, 2)
            );
            document.getElementById('consentSchema').value = loadFromStorage(
                STORAGE_KEYS.consentJson,
                JSON.stringify(DEFAULT_CONSENT_SCHEMA, null, 2)
            );
            document.getElementById('compressionType').value = loadFromStorage(
                STORAGE_KEYS.compressionType,
                'bzip2'
            );
            document.getElementById('recordsToHydrate').value = loadFromStorage(
                STORAGE_KEYS.recordsMillions,
                150
            );
            document.getElementById('bandwidthLimit').value = loadFromStorage(
                STORAGE_KEYS.bandwidthLimitTb,
                2
            );

            const profileRate = loadFromStorage(STORAGE_KEYS.profileChangeRate, 10);
            document.getElementById('profileChangeRate').value = profileRate;
            document.getElementById('profileChangeSlider').value = profileRate;

            const consentRate = loadFromStorage(STORAGE_KEYS.consentChangeRate, 5);
            document.getElementById('consentChangeRate').value = consentRate;
            document.getElementById('consentChangeSlider').value = consentRate;

            document.getElementById('growthDate').value = loadFromStorage(
                STORAGE_KEYS.growthDate,
                getDefaultGrowthDate()
            );
            document.getElementById('growthMultiplier').value = loadFromStorage(
                STORAGE_KEYS.growthMultiplier,
                1.5
            );

            // Load UI state
            const uiState = loadFromStorage(STORAGE_KEYS.uiState, {
                profileExpanded: false,
                consentExpanded: false
            });
            if (uiState.profileExpanded) document.getElementById('profilePanel').classList.add('expanded');
            if (uiState.consentExpanded) document.getElementById('consentPanel').classList.add('expanded');

            // Update previews
            updatePreview('profile');
            updatePreview('consent');

            // Set up event listeners
            setupEventListeners();

            // Initial calculation
            calculate();
        }

        function setupEventListeners() {
            // Schema textareas
            document.getElementById('profileSchema').addEventListener('input', function() {
                updatePreview('profile');
                debouncedSave(STORAGE_KEYS.profileJson, this.value);
                calculate();
            });

            document.getElementById('consentSchema').addEventListener('input', function() {
                updatePreview('consent');
                debouncedSave(STORAGE_KEYS.consentJson, this.value);
                calculate();
            });

            // Compression type
            document.getElementById('compressionType').addEventListener('change', function() {
                saveToStorage(STORAGE_KEYS.compressionType, this.value);
                calculate();
            });

            // Records
            document.getElementById('recordsToHydrate').addEventListener('input', function() {
                saveToStorage(STORAGE_KEYS.recordsMillions, parseFloat(this.value) || 0);
                calculate();
            });

            // Bandwidth limit
            document.getElementById('bandwidthLimit').addEventListener('input', function() {
                saveToStorage(STORAGE_KEYS.bandwidthLimitTb, parseFloat(this.value) || 0);
                calculate();
            });

            // Profile change rate - sync slider and input
            document.getElementById('profileChangeSlider').addEventListener('input', function() {
                let value = Math.min(100, Math.max(0, parseFloat(this.value) || 0));
                document.getElementById('profileChangeRate').value = value;
                saveToStorage(STORAGE_KEYS.profileChangeRate, value);
                calculate();
            });

            document.getElementById('profileChangeRate').addEventListener('input', function() {
                let value = Math.min(100, Math.max(0, parseFloat(this.value) || 0));
                this.value = value;
                document.getElementById('profileChangeSlider').value = value;
                saveToStorage(STORAGE_KEYS.profileChangeRate, value);
                calculate();
            });

            // Consent change rate - sync slider and input
            document.getElementById('consentChangeSlider').addEventListener('input', function() {
                let value = Math.min(100, Math.max(0, parseFloat(this.value) || 0));
                document.getElementById('consentChangeRate').value = value;
                saveToStorage(STORAGE_KEYS.consentChangeRate, value);
                calculate();
            });

            document.getElementById('consentChangeRate').addEventListener('input', function() {
                let value = Math.min(100, Math.max(0, parseFloat(this.value) || 0));
                this.value = value;
                document.getElementById('consentChangeSlider').value = value;
                saveToStorage(STORAGE_KEYS.consentChangeRate, value);
                calculate();
            });

            // Growth date
            document.getElementById('growthDate').addEventListener('change', function() {
                saveToStorage(STORAGE_KEYS.growthDate, this.value);
                calculate();
            });

            // Growth multiplier
            document.getElementById('growthMultiplier').addEventListener('input', function() {
                saveToStorage(STORAGE_KEYS.growthMultiplier, parseFloat(this.value) || 1);
                calculate();
            });
        }

        function calculate() {
            // Validate schemas
            const profileStr = document.getElementById('profileSchema').value;
            const consentStr = document.getElementById('consentSchema').value;

            const profileValidation = validateJson(profileStr);
            const consentValidation = validateJson(consentStr);

            state.profileValid = profileValidation.valid;
            state.consentValid = consentValidation.valid;

            // Update UI for validation
            const profileTextarea = document.getElementById('profileSchema');
            const consentTextarea = document.getElementById('consentSchema');
            const profileError = document.getElementById('profileError');
            const consentError = document.getElementById('consentError');

            profileTextarea.classList.toggle('invalid', !state.profileValid);
            consentTextarea.classList.toggle('invalid', !state.consentValid);
            profileError.textContent = state.profileValid ? '' : 'Invalid JSON: ' + profileValidation.error;
            consentError.textContent = state.consentValid ? '' : 'Invalid JSON: ' + consentValidation.error;

            // Get byte counts
            const profileBytes = getByteLength(profileStr);
            const consentBytes = getByteLength(consentStr);

            document.getElementById('profileByteCount').textContent = formatNumber(profileBytes) + ' bytes';
            document.getElementById('consentByteCount').textContent = formatNumber(consentBytes) + ' bytes';

            // If either schema is invalid, stop calculations
            if (!state.profileValid || !state.consentValid) {
                return;
            }

            // Get input values
            const compressionType = document.getElementById('compressionType').value;
            const compressionRatio = COMPRESSION_RATIOS[compressionType];
            const recordsMillions = parseFloat(document.getElementById('recordsToHydrate').value) || 0;
            const bandwidthLimitTb = parseFloat(document.getElementById('bandwidthLimit').value) || 0;
            const profileChangeRate = parseFloat(document.getElementById('profileChangeRate').value) || 0;
            const consentChangeRate = parseFloat(document.getElementById('consentChangeRate').value) || 0;
            const growthDateStr = document.getElementById('growthDate').value;
            const growthMultiplier = parseFloat(document.getElementById('growthMultiplier').value) || 1;

            // Calculate compressed sizes
            const profileCompressedBytes = profileBytes / compressionRatio;
            const consentCompressedBytes = consentBytes / compressionRatio;
            const combinedCompressedBytes = profileCompressedBytes + consentCompressedBytes;

            // Calculate totals
            const totalRecords = recordsMillions * 1000000;
            const hydrationBytes = totalRecords * combinedCompressedBytes;
            const annualLimitBytes = bandwidthLimitTb * 1024 * 1024 * 1024 * 1024;

            // Daily sync calculations
            const profileDailyRecords = totalRecords * (profileChangeRate / 100);
            const consentDailyRecords = totalRecords * (consentChangeRate / 100);
            const totalDailyRecords = profileDailyRecords + consentDailyRecords;
            const dailyBytes = (profileDailyRecords * profileCompressedBytes) + (consentDailyRecords * consentCompressedBytes);

            // Budget calculations
            const remainingAfterHydration = annualLimitBytes - hydrationBytes;
            const daysAvailable = dailyBytes > 0 ? remainingAfterHydration / dailyBytes : Infinity;
            const annualUsageBytes = hydrationBytes + (dailyBytes * 350);
            const annualUsagePercent = (annualUsageBytes / annualLimitBytes) * 100;
            const sustainable = annualUsagePercent <= 100;

            // Update Profile Metrics
            document.getElementById('profileUncompressed').textContent = formatBytes(profileBytes);
            document.getElementById('profileCompressed').textContent = formatBytes(profileCompressedBytes);
            document.getElementById('profileRatio').textContent = compressionRatio.toFixed(1) + 'x';

            // Update Consent Metrics
            document.getElementById('consentUncompressed').textContent = formatBytes(consentBytes);
            document.getElementById('consentCompressed').textContent = formatBytes(consentCompressedBytes);
            document.getElementById('consentRatio').textContent = compressionRatio.toFixed(1) + 'x';

            // Update Combined Metrics
            document.getElementById('combinedUncompressed').textContent = formatBytes(profileBytes + consentBytes);
            document.getElementById('combinedCompressed').textContent = formatBytes(combinedCompressedBytes);
            document.getElementById('combinedTotal').textContent = formatBytes(hydrationBytes);

            // Update Hydration Summary
            document.getElementById('hydrationRecords').textContent = formatNumber(totalRecords);
            document.getElementById('hydrationSize').textContent = formatBytes(hydrationBytes);
            document.getElementById('hydrationPercent').textContent = formatPercent((hydrationBytes / annualLimitBytes) * 100);
            document.getElementById('hydrationRemaining').textContent = formatBytes(Math.max(0, remainingAfterHydration));

            // Update Daily Sync Summary
            document.getElementById('dailyProfileRecords').textContent = formatNumber(Math.round(profileDailyRecords)) +
                ' (' + profileChangeRate + '%)';
            document.getElementById('dailyConsentRecords').textContent = formatNumber(Math.round(consentDailyRecords)) +
                ' (' + consentChangeRate + '%)';
            document.getElementById('dailyTotalRecords').textContent = formatNumber(Math.round(totalDailyRecords));
            document.getElementById('dailySize').textContent = formatBytes(dailyBytes) + '/day';
            document.getElementById('monthlySize').textContent = formatBytes(dailyBytes * 30);

            // Update Budget Forecast
            const budgetCard = document.getElementById('budgetForecast');
            budgetCard.classList.remove('success', 'warning', 'danger');

            if (remainingAfterHydration < 0) {
                document.getElementById('forecastDays').textContent = 'OVER BUDGET';
                document.getElementById('forecastMonths').textContent = '-';
                document.getElementById('forecastSustainable').innerHTML = '<span class="status-badge danger">NO</span>';
                document.getElementById('forecastUsage').textContent = formatPercent(annualUsagePercent);
                budgetCard.classList.add('danger');
            } else if (daysAvailable === Infinity) {
                document.getElementById('forecastDays').textContent = '∞ (no daily sync)';
                document.getElementById('forecastMonths').textContent = '∞';
                document.getElementById('forecastSustainable').innerHTML = '<span class="status-badge success">YES</span>';
                document.getElementById('forecastUsage').textContent = formatPercent((hydrationBytes / annualLimitBytes) * 100);
                budgetCard.classList.add('success');
            } else {
                document.getElementById('forecastDays').textContent = Math.round(daysAvailable) + ' days';
                document.getElementById('forecastMonths').textContent = (daysAvailable / 30).toFixed(1) + ' months';

                if (annualUsagePercent <= 80) {
                    document.getElementById('forecastSustainable').innerHTML = '<span class="status-badge success">YES</span>';
                    budgetCard.classList.add('success');
                } else if (annualUsagePercent <= 100) {
                    document.getElementById('forecastSustainable').innerHTML = '<span class="status-badge warning">CAUTION</span>';
                    budgetCard.classList.add('warning');
                } else {
                    document.getElementById('forecastSustainable').innerHTML = '<span class="status-badge danger">NO</span>';
                    budgetCard.classList.add('danger');
                }

                document.getElementById('forecastUsage').textContent = formatPercent(annualUsagePercent);
            }

            // Growth Projection
            calculateGrowthProjection(
                profileCompressedBytes,
                consentCompressedBytes,
                dailyBytes,
                hydrationBytes,
                remainingAfterHydration,
                annualLimitBytes,
                profileDailyRecords,
                consentDailyRecords,
                growthDateStr,
                growthMultiplier
            );
        }

        function calculateGrowthProjection(
            profileCompressed,
            consentCompressed,
            dailyBytes,
            hydrationBytes,
            remainingAfterHydration,
            annualLimitBytes,
            profileDailyRecords,
            consentDailyRecords,
            growthDateStr,
            multiplier
        ) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            let growthDate = new Date(growthDateStr + 'T00:00:00');

            // Handle growth date warnings
            const dateWarning = document.getElementById('growthDateWarning');
            const multiplierInfo = document.getElementById('growthMultiplierInfo');

            const dateInPast = growthDate <= today;
            dateWarning.style.display = dateInPast ? 'block' : 'none';
            if (dateInPast) {
                growthDate = new Date(today);
            }

            multiplierInfo.style.display = multiplier < 1 ? 'block' : 'none';

            // Calculate days until growth
            const daysUntilGrowth = Math.max(0, Math.floor((growthDate - today) / (1000 * 60 * 60 * 24)));

            // Grown sizes
            const profileCompressedGrown = profileCompressed * multiplier;
            const consentCompressedGrown = consentCompressed * multiplier;
            const combinedCompressedGrown = profileCompressedGrown + consentCompressedGrown;
            const dailyBytesGrown = (profileDailyRecords * profileCompressedGrown) + (consentDailyRecords * consentCompressedGrown);

            // Days available at current size (without growth)
            const daysAtCurrentSizeTotal = dailyBytes > 0 ? remainingAfterHydration / dailyBytes : Infinity;

            let daysAtCurrentSize, daysAtGrownSize, totalDays, projectedAnnualUsage;

            if (remainingAfterHydration <= 0) {
                // Already over budget from hydration alone
                daysAtCurrentSize = 0;
                daysAtGrownSize = 0;
                totalDays = 0;
                projectedAnnualUsage = (hydrationBytes / annualLimitBytes) * 100;
            } else if (dailyBytes === 0) {
                // No daily sync
                daysAtCurrentSize = Infinity;
                daysAtGrownSize = Infinity;
                totalDays = Infinity;
                projectedAnnualUsage = (hydrationBytes / annualLimitBytes) * 100;
            } else if (daysAtCurrentSizeTotal <= daysUntilGrowth) {
                // Budget exhausted before growth date
                daysAtCurrentSize = daysAtCurrentSizeTotal;
                daysAtGrownSize = 0;
                totalDays = daysAtCurrentSize;
                projectedAnnualUsage = 100; // Exactly hits limit
            } else {
                // Budget continues past growth date
                daysAtCurrentSize = daysUntilGrowth;
                const budgetUsedBeforeGrowth = dailyBytes * daysUntilGrowth;
                const remainingAtGrowth = remainingAfterHydration - budgetUsedBeforeGrowth;
                daysAtGrownSize = dailyBytesGrown > 0 ? remainingAtGrowth / dailyBytesGrown : Infinity;
                totalDays = daysAtCurrentSize + daysAtGrownSize;

                // Calculate annual projection
                if (totalDays >= 350) {
                    const daysAtGrown350 = Math.max(0, 350 - daysUntilGrowth);
                    const daysAtCurrent350 = Math.min(daysUntilGrowth, 350);
                    const annualUsage = hydrationBytes + (dailyBytes * daysAtCurrent350) + (dailyBytesGrown * daysAtGrown350);
                    projectedAnnualUsage = (annualUsage / annualLimitBytes) * 100;
                } else {
                    // Will exhaust before 350 days
                    projectedAnnualUsage = 100;
                }
            }

            // Build the growth comparison HTML
            const growthComparisonEl = document.getElementById('growthComparison');

            const formatDays = (days) => {
                if (days === Infinity) return '∞';
                if (days <= 0) return '0';
                return Math.round(days).toLocaleString();
            };

            growthComparisonEl.innerHTML = `
                <div class="growth-title">GROWTH PROJECTION: Schema grows ${multiplier}x on ${formatDate(growthDate)}</div>

                <table class="growth-table">
                    <tr>
                        <th></th>
                        <th>CURRENT</th>
                        <th></th>
                        <th>AFTER GROWTH</th>
                    </tr>
                    <tr>
                        <td>Profile (compressed)</td>
                        <td>${formatBytes(profileCompressed)}</td>
                        <td>→</td>
                        <td>${formatBytes(profileCompressedGrown)}</td>
                    </tr>
                    <tr>
                        <td>Consent (compressed)</td>
                        <td>${formatBytes(consentCompressed)}</td>
                        <td>→</td>
                        <td>${formatBytes(consentCompressedGrown)}</td>
                    </tr>
                    <tr>
                        <td>Combined per record</td>
                        <td>${formatBytes(profileCompressed + consentCompressed)}</td>
                        <td>→</td>
                        <td>${formatBytes(combinedCompressedGrown)}</td>
                    </tr>
                    <tr>
                        <td>Daily sync size</td>
                        <td>${formatBytes(dailyBytes)}</td>
                        <td>→</td>
                        <td>${formatBytes(dailyBytesGrown)}</td>
                    </tr>
                </table>

                <div class="growth-impact">
                    <div class="growth-impact-title">IMPACT ON BUDGET:</div>
                    <div class="growth-impact-item">├── Days at current size (until ${formatDate(growthDate)}): <strong>${formatDays(daysAtCurrentSize)} days</strong></div>
                    <div class="growth-impact-item">├── Days at grown size (after ${formatDate(growthDate)}): <strong>${formatDays(daysAtGrownSize)} days</strong></div>
                    <div class="growth-impact-item">├── Total days available: <strong>${formatDays(totalDays)} days</strong></div>
                    <div class="growth-impact-item">└── Projected annual usage: <strong style="color: ${projectedAnnualUsage > 100 ? 'var(--danger-color)' : projectedAnnualUsage > 80 ? 'var(--warning-color)' : 'var(--success-color)'}">${projectedAnnualUsage === Infinity ? 'N/A' : formatPercent(projectedAnnualUsage)}</strong></div>
                </div>
            `;
        }

        function resetToDefaults() {
            if (!confirm('This will reset all settings to their defaults. Continue?')) {
                return;
            }

            // Clear localStorage
            if (state.localStorageAvailable) {
                Object.values(STORAGE_KEYS).forEach(key => {
                    localStorage.removeItem(key);
                });
            }

            // Reset form values
            document.getElementById('profileSchema').value = JSON.stringify(DEFAULT_PROFILE_SCHEMA, null, 2);
            document.getElementById('consentSchema').value = JSON.stringify(DEFAULT_CONSENT_SCHEMA, null, 2);
            document.getElementById('compressionType').value = 'bzip2';
            document.getElementById('recordsToHydrate').value = 150;
            document.getElementById('bandwidthLimit').value = 2;
            document.getElementById('profileChangeRate').value = 10;
            document.getElementById('profileChangeSlider').value = 10;
            document.getElementById('consentChangeRate').value = 5;
            document.getElementById('consentChangeSlider').value = 5;
            document.getElementById('growthDate').value = getDefaultGrowthDate();
            document.getElementById('growthMultiplier').value = 1.5;

            // Reset UI state
            document.getElementById('profilePanel').classList.remove('expanded');
            document.getElementById('consentPanel').classList.remove('expanded');

            // Update previews
            updatePreview('profile');
            updatePreview('consent');

            // Recalculate
            calculate();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
